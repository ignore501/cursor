#!/bin/bash

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p logs

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞..."
python3 scripts/check_bot_status.py

# –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
if [ $? -eq 0 ]; then
    echo "–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if [ -f bot.pid ]; then
        pid=$(cat bot.pid)
        if ps -p $pid > /dev/null; then
            echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ (PID: $pid)..."
            kill $pid
            sleep 2
        fi
    fi
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
    nohup python3 scripts/autopost.py > logs/bot.log 2>&1 &
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º PID
    echo $! > bot.pid
    
    echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å PID: $(cat bot.pid)"
    echo "üìù –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ñ–∞–π–ª–µ: logs/bot.log"
else
    echo "‚ùå –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏"
    exit 1
fi 